#include <stdio.h>
#include <gsl/gsl_matrix.h>
#include <gsl/gsl_blas.h>
#include <time.h>

//Could be done simpler/shorter with blas, because it can add operators and constant to matrices when multiplying, in one line


double main(){

	clock_t start_time,end_time;
	double elapsed_time;

	printf("Computing the covariance matrix...\n");
	
	start_time=clock();

	int num_samples=5;
	int data_per_sample=129;
/*
	double samples_re[] = { 0,0,3,0,0,
				0,0,0,0,-2,
				0,0,54,0,3,
				0,0,0,0,0,
				43,0,1,0,4
				};

	double samples_im[] = { 0,0,22,0,0,
				-5,0,110,0,0,
				0,0,-3,0,0,
				0,0,0,0,33,
				0,0,32,0,0
				};
*/
	double samples_re[]={-3285,-3638,102,3726,3158,-964,-4002,-2538,1781,4095,1802,-2519,-4007,-987,3143,3736,126,-3627,-3300,739,3946,2713,-1573,-4089,-2006,2334,4047,1207,-2992,-3825,-355,3514,3429,-514,-3879,-2881,1358,4069,2201,-2143,-4077,-1425,2830,3900,582,-3392,-3550,285,3799,3038,-1141,-4037,-2392,1944,4092,1636,-2661,-3965,-808,3257,3658,-57,-3708,-3188,918,3991,2573,-1740,-4096,-1844,2482,4015,1031,-3114,-3756,-173,3604,3326,-695,-3934,-2748,1529,4085,2045,-2297,-4055,-1251,2960,3840,400,-3491,-3455,467,3863,2912,-1316,-4064,-2241,2103,4080,1466,-2798,-3915,-628,3365,3572,-240,-3782,-3070,1096,4028,2428,-1904,-4095,-1679,2625,3975,852,-3230,-3679,10,3688,3215,-875,-3981,-2609,1698,4094,1884,-1289,2932,3854,439,-3470,-3476,428,3850,2940,-1278,-4059,-2274,2069,4083,1503,-2769,-3926,-667,3342,3591,-201,-3767,-3096,1058,4021,2459,-1869,-4096,-1715,2595,3984,891,-3206,-3696,-29,3670,3240,-836,-3972,-2640,1662,4093,1919,-2415,-4032,-1114,3057,3788,257,-3564,-3376,610,3909,2809,-1451,-4080,-2119,2225,4065,1331,-2901,-3870,-486,3445,3499,-384,-3835,-2973,1234,4052,2310,-2030,-4088,-1547,2734,3938,711,-3316,-3613,154,3748,3124,-1015,-4013,-2497,1828,4095,1755,-2560,-3996,-936,3176,3715,74,-3651,-3268,790,3959,2673,-1621,-4092,-1960,2377,4039,1157,-3027,-3806,-303,3540,3400,-566,-3896,-2844,1407,4074,2157,-2188,-4072,-1375,2868,3884,530,-3421,-3524,337,3818,3003,-1191,-4046,4096,1791,-2529,-4004,-976,3150,3731,114,-3632,-3293,751,3949,2704,-1584,-4090,-1995,2344,4045,1195,-3000,-3821,-344,3520,3423,-526,-3883,-2872,1369,4070,2191,-2153,-4076,-1413,2839,3896,570,-3398,-3544,297,3803,3030,-1152,-4039,-2382,1954,4091,1625,-2670,-3962,-797,3264,3652,-69,-3713,-3180,930,3994,2564,-1751,-4096,-1833,2491,4013,1019,-3122,-3751,-161,3610,3319,-707,-3938,-2739,1540,4086,2034,-2307,-4053,-1240,2968,3836,388,-3497,-3449,479,3867,2904,-1327,-4066,-2231,2113,4079,1455,-2806,-3911,-616,3371,3566,-252,-3787,-3062,1107,4030,2418,-1915,-4094,-1668,2634,3972,841,-3237,-3674,22,3693,3208,-886,-3984,-2600,1709,4094,1873,-2456,-4023,-1064,3091,3768,205,-3589,-3346,661,-1288,-4060,-2265,2078,4083,1494,-2776,-3923,-657,3348,3586,-211,-3771,-3089,1068,4023,2451,-1878,-4095,-1705,2603,3982,881,-3212,-3692,-19,3675,3233,-846,-3974,-2632,1671,4093,1910,-2423,-4030,-1104,3064,3784,247,-3569,-3370,620,3912,2802,-1461,-4081,-2110,2234,4064,1322,-2908,-3867,-476,3450,3494,-394,-3839,-2966,1243,4053,2302,-2039,-4087,-1537,2741,3935,701,-3322,-3609,164,3752,3118,-1024,-4015,-2489,1837,4095,1746,-2568,-3994,-927,3182,3710,64,-3655,-3262,800,3962,2666,-1630,-4093,-1951,2385,4037,1147,-3034,-3802,-293,3545,3395,-576,-3899,-2836,1417,4075,2148,-2196,-4070,-1366,2875,3881,520,-3426,-3518,347,3822,2996,-1201,-4047,-2341,1998,4089,1579,-2708,-3949,-747,3294,3629,-3288,759,3951,2698,-1591,-4091,-1988,2350,4044,1187,-3006,-3818,-335,3524,3418,-534,-3886,-2867,1377,4071,2184,-2160,-4075,-1406,2845,3894,562,-3403,-3540,305,3806,3025,-1160,-4040,-2375,1962,4091,1617,-2676,-3960,-789,3269,3648,-77,-3717,-3175,938,3995,2557,-1759,-4096,-1826,2498,4011,1011,-3127,-3748,-152,3614,3314,-715,-3940,-2733,1548,4087,2027,-2314,-4052,-1232,2973,3833,380,-3501,-3444,487,3870,2898,-1335,-4067,-2224,2120,4078,1448,-2812,-3909,-608,3376,3562,-260,-3790,-3056,1115,4032,2412,-1922,-4094,-1660,2641,3970,833,-3242,-3670,31,3696,3203,-894,-3986,-2594,1716,4095,1866,-2463,-4021,-1056,3096,3765,197,-3593,-3341,669,3926,2766,-1507,-4085,-2068,2275,4058,1275,-2943};

	double samples_im[]={2446,-1884,-4095,-1700,2608,3981,875,-3216,-3689,-12,3678,3230,-852,-3976,-2627,1677,4094,1904,-2428,-4029,-1098,3068,3782,240,-3572,-3366,626,3914,2797,-1467,-4081,-2105,2239,4063,1316,-2913,-3865,-469,3453,3490,-400,-3841,-2961,1250,4054,2297,-2045,-4087,-1531,2746,3933,695,-3326,-3606,171,3754,3114,-1031,-4016,-2484,1842,4095,1740,-2573,-3992,-920,3186,3708,57,-3658,-3258,807,3964,2661,-1636,-4093,-1946,2390,4036,1141,-3038,-3800,-287,3548,3391,-582,-3901,-2832,1423,4076,2143,-2201,-4070,-1360,2879,3879,514,-3430,-3515,354,3824,2992,-1207,-4048,-2336,2004,4088,1573,-2713,-3947,-741,3298,3626,-126,-3737,-3144,985,4006,2519,-1802,-4096,-1783,2536,4001,964,-3158,-3728,-104,3636,-3889,-2860,1386,4072,2176,-2168,-4074,-1397,2851,3891,553,-3408,-3535,314,3810,3018,-1169,-4042,-2368,1970,4091,1609,-2683,-3957,-780,3275,3644,-87,-3721,-3169,947,3997,2550,-1767,-4096,-1818,2505,4009,1002,-3133,-3744,-143,3618,3308,-724,-3942,-2726,1557,4087,2019,-2321,-4051,-1223,2980,3830,371,-3506,-3439,497,3873,2892,-1344,-4068,-2216,2128,4078,1439,-2819,-3906,-599,3381,3557,-270,-3794,-3050,1124,4033,2404,-1930,-4094,-1652,2648,3968,824,-3248,-3666,40,3700,3197,-903,-3988,-2587,1724,4095,1858,-2470,-4019,-1047,3102,3761,188,-3597,-3336,678,3929,2759,-1515,-4085,-2060,2282,4056,1266,-2949,-3847,-417,3481,3463,-452,-3859,-2925,1299,4061,2253,-2090,-4083,-1483,2785,3919,643,-1,3683,3222,-864,-3979,-2618,1688,4094,1894,-2438,-4027,-1086,3076,3777,228,-3578,-3359,638,3917,2789,-1478,-4082,-2095,2249,4062,1304,-2921,-3861,-457,3460,3484,-412,-3845,-2953,1261,4056,2287,-2055,-4086,-1520,2755,3930,683,-3333,-3600,183,3759,3106,-1042,-4018,-2474,1853,4095,1729,-2582,-3989,-909,3194,3703,45,-3663,-3251,818,3967,2652,-1647,-4093,-1935,2400,4034,1129,-3046,-3796,-275,3554,3384,-594,-3904,-2823,1434,4077,2133,-2211,-4068,-1349,2888,3875,502,-3436,-3509,365,3828,2983,-1218,-4050,-2326,2014,4088,1562,-2722,-3944,-729,3305,3621,-138,-3742,-3137,997,4008,2510,-1813,-4096,-1772,2546,3999,952,-3166,-3723,-92,3642,3278,-774,-3956,-2688,1604,4090,1974,-2363,-4043,3888,543,-3413,-3530,324,3813,3012,-1179,-4044,-2360,1978,4090,1600,-2691,-3955,-770,3281,3640,-97,-3725,-3163,957,4000,2542,-1776,-4096,-1809,2513,4007,992,-3140,-3740,-133,3623,3302,-734,-3945,-2718,1566,4088,2010,-2330,-4049,-1214,2987,3826,361,-3511,-3434,507,3876,2884,-1353,-4069,-2208,2137,4077,1430,-2826,-3903,-589,3387,3552,-280,-3797,-3043,1134,4035,2396,-1939,-4093,-1643,2655,3965,814,-3254,-3661,50,3705,3191,-913,-3990,-2579,1734,4095,1849,-2478,-4017,-1038,3109,3757,178,-3602,-3330,688,3931,2752,-1525,-4086,-2051,2291,4055,1257,-2956,-3844,-407,3487,3457,-462,-3862,-2918,1309,4062,2245,-2099,-4082,-1473,2792,3916,633,-3362,-3576,233,3779,3073,-1091,-4028,-2434,1898,-2444,-4025,-1078,3081,3774,220,-3582,-3355,646,3919,2783,-1485,-4083,-2087,2256,4061,1297,-2927,-3858,-449,3464,3480,-420,-3848,-2947,1269,4057,2280,-2062,-4085,-1513,2761,3928,675,-3338,-3596,191,3762,3101,-1050,-4020,-2468,1860,4095,1722,-2589,-3988,-901,3199,3699,37,-3667,-3246,826,3969,2646,-1655,-4094,-1928,2406,4033,1122,-3052,-3792,-267,3558,3380,-602,-3907,-2817,1442,4078,2126,-2218,-4067,-1341,2894,3872,494,-3441,-3505,374,3831,2978,-1226,-4051,-2319,2022,4087,1554,-2728,-3942,-721,3310,3617,-146,-3745,-3131,1005,4010,2503,-1820,-4096,-1764,2552,3997,944,-3171,-3719,-84,3646,3273,-782,-3958,-2681,1612,4091,1967,-2370,-4041,-1167,3020,3809,311,-3537,-3406,556,3892,2849};

	gsl_matrix* matrix_sample_re = gsl_matrix_alloc(num_samples,data_per_sample);
	gsl_matrix* matrix_sample_im = gsl_matrix_alloc(num_samples,data_per_sample);

	//Set the values in the martix accoring to the samples in the array
	for (int i = 0; i < num_samples; i++) {
     	   for (int j = 0; j < data_per_sample; j++) {
		double re = samples_re[i * 5 + j]; 
        	double im = samples_im[i * 5 + j];
		gsl_matrix_set(matrix_sample_re, i, j, re);
        	gsl_matrix_set(matrix_sample_im, i, j, im);        	
	   }
    	}

	gsl_matrix* matrix_hermit_re = gsl_matrix_alloc(data_per_sample,num_samples); //switch dimensions 
	gsl_matrix_transpose_memcpy(matrix_hermit_re, matrix_sample_re); // Transpose real part

	gsl_matrix* matrix_hermit_im = gsl_matrix_alloc(data_per_sample,num_samples); //switch dimensions
	gsl_matrix_transpose_memcpy(matrix_hermit_im, matrix_sample_im); //Transpose imaginary part
	gsl_matrix_scale(matrix_hermit_im, -1); //Flip sign imaginary part

	// d: type double, ge: general , mm: matrix multiplication. Result stored in 'C' (last argument)
	gsl_matrix* result_re = gsl_matrix_alloc(num_samples,num_samples); 
	gsl_blas_dgemm(CblasNoTrans, CblasNoTrans, 1, matrix_sample_re,matrix_hermit_re,0,result_re);

	//                                        subtract                             from previous
	gsl_blas_dgemm(CblasNoTrans, CblasNoTrans, -1, matrix_sample_im,matrix_hermit_im,1,result_re);
	


	gsl_matrix* result_im = gsl_matrix_alloc(num_samples,num_samples);
	gsl_blas_dgemm(CblasNoTrans, CblasNoTrans, 1, matrix_sample_re,matrix_hermit_im,0,result_im);
	
	//                                        add                             to previous
	gsl_blas_dgemm(CblasNoTrans, CblasNoTrans, 1, matrix_sample_im,matrix_hermit_re,1,result_im);
		
	//Divide results by n: number of samples
	double scale = 1./data_per_sample;
	gsl_matrix_scale(result_im, scale);
	gsl_matrix_scale(result_re, scale);

	end_time=clock();
	elapsed_time = (double)(end_time - start_time) / CLOCKS_PER_SEC;

	//Print the matrix
	printf("Matrix result:\n");
	for (int i = 0; i < num_samples; i++) {
    		for (int j = 0; j < num_samples; j++) {
        		double num_re = gsl_matrix_get(result_re, i, j);
        		double num_im = gsl_matrix_get(result_im, i, j);
        		printf("%f ", num_re);
			printf("%f", num_im);
			printf("i\t");


    		}
    	printf("\n"); // Move to the next row
	}
	
	printf("\nElapsed time: %f seconds\n", elapsed_time);
	return elapsed_time;

}


